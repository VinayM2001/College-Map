<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NID Campus 3D Map - Compass Aligned</title>
    <style>
        body { margin: 0; overflow: hidden; } 
        canvas { display: block; }
        #compass-status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
          }
        }
    </script>
</head>
<body>
    <div id="compass-status">Compass: Connecting...</div>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. Setup Scene, Camera, and Renderer ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });

        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- 2. Add Camera Controls (Orbit, Pan, Zoom) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; 
        controls.minPolarAngle = 0;             // Allow orbiting from straight above (top)
        controls.maxPolarAngle = Math.PI / 2;   // Stop orbiting at the ground plane (no bottom view)
        controls.maxDistance = 20;              // Limit max zoom-out distance
        controls.minDistance = 3;               // Limit min zoom-in distance
        
        // Initial camera position (adjust to center your map)
        camera.position.set(5, 7, 5); 
        controls.update();

        // --- 3. Add Lighting ---
        scene.add(new THREE.AmbientLight(0xffffff, 1.0));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
        directionalLight.position.set(10, 15, 5);
        scene.add(directionalLight);

        let mapModel = null; // Variable to hold the loaded 3D model

        // --- 4. Load the 3D Model ---
        const loader = new GLTFLoader();

        // **IMPORTANT:** Replace with your actual model path
        loader.load(
            './map.glb', 
            function (gltf) {
                mapModel = gltf.scene;
                // Ensure your model's 'North' direction aligns with its positive Z-axis.
                // If it was modeled differently, you might need a small initial rotation here.
                scene.add(mapModel);
                controls.target.copy(mapModel.position);
                controls.update();
            },
            function (xhr) {
                console.log('Model loaded: ' + (xhr.loaded / xhr.total * 100).toFixed(2) + '%');
            },
            function (error) {
                console.error('An error occurred while loading the model:', error);
            }
        );

        // --- 5. Compass Alignment Logic (Device Orientation) ---
        const statusElement = document.getElementById('compass-status');
        let initialAlpha = null; // Stores the initial North direction of the device
        
        function handleOrientation(event) {
            // The 'alpha' value is the compass direction (0-360 degrees) relative to North.
            let alpha = event.alpha;

            if (alpha === null) {
                statusElement.textContent = "Compass: Data Unavailable";
                return;
            }

            // --- 5.1 Handle Permissions (iOS 13+ and some browsers) ---
            if (typeof event.webkitCompassHeading !== 'undefined') {
                // Use non-standard webkit value if available (more stable on iOS)
                alpha = event.webkitCompassHeading;
            } else if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // Request permission for security/privacy (for modern mobile browsers)
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState !== 'granted') {
                            statusElement.textContent = "Compass: Permission Denied";
                        }
                    })
                    .catch(console.error);
            }

            if (mapModel) {
                // Step 1: Initialize the starting direction
                if (initialAlpha === null) {
                    initialAlpha = alpha;
                    statusElement.textContent = `Compass: Initialized (${alpha.toFixed(1)}°)`
                }

                // Step 2: Calculate the required rotation difference
                // Rotation is calculated as the difference between the current device orientation (alpha)
                // and the initial orientation when the app started.
                const rotationAngle = (alpha - initialAlpha) * (Math.PI / 180);

                // Step 3: Apply rotation to the entire 3D map scene (around the Y-axis)
                // We rotate the model by the negative angle because rotating the model clockwise 
                // is equivalent to turning the camera counter-clockwise.
                mapModel.rotation.y = -rotationAngle;
            }

            // statusElement.textContent = `Compass: ${alpha.toFixed(1)}° | Rot: ${(-rotationAngle * 180 / Math.PI).toFixed(1)}°`;
        }

        // Attach the event listener for device orientation
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', handleOrientation, true);
        } else {
            statusElement.textContent = "Compass: Not Supported";
        }

        // --- 6. Animation Loop & Resize Handler ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize, false);
        animate();
    </script>
</body>
</html>
