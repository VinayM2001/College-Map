<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Map with Smart Orientation</title>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
<style>
  body, html { margin:0; padding:0; height:100%; }
  model-viewer { width:100%; height:100vh; background:#f5f5f5; }

  /* Hotspot styling */
  .hotspot {
    background: rgba(255,255,255,0.9);
    border-radius:8px;
    border:1px solid #ccc;
    padding:4px 8px;
    font-size:12px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
  }

  .hotspot img { width:16px; height:16px; }

  /* Recenter button */
  #recenterBtn {
    position:absolute; bottom:20px; right:20px;
    padding:8px 14px; background:#222; color:white; border:none;
    border-radius:6px; cursor:pointer; opacity:0.8;
  }
  #recenterBtn:hover { opacity:1; }
</style>
</head>
<body>

<model-viewer
  id="mapModel"
  src="G_floor_Final.glb"
  alt="3D Interactive Map"
  camera-controls
  min-camera-orbit="0deg 10deg auto"    <!-- restrict bottom tilt -->
  max-camera-orbit="360deg 90deg auto"  <!-- allow full horizontal + top view -->
  field-of-view="50deg"
  touch-action="pan-y"
>
  <!-- Hotspot -->
  <button slot="hotspot-info" data-position="2 1 1" data-normal="0 1 0" class="hotspot"
    onclick="window.open('https://example.com/info','_blank')">
    <img src="info.png" alt="Info"><span>Info Desk</span>
  </button>
</model-viewer>

<button id="recenterBtn">Recenter</button>

<script>
const model = document.getElementById('mapModel');
const recenterBtn = document.getElementById('recenterBtn');

// === CONFIG ===
const northOffset = 90;  // Adjust to align model north
const tiltAngle = 60;    // Keep top-to-front tilt static

// Track user interaction
let userInteracting = false;
let orientationActive = true;

// Device orientation handler
function handleOrientation(event) {
  if (!orientationActive) return;

  let heading = event.webkitCompassHeading || (360 - event.alpha);
  if (heading !== null && heading !== undefined) {
    const correctedHeading = (heading + northOffset) % 360;
    // Only rotate around vertical axis (y-axis), keep tilt fixed
    const currentOrbit = model.getCameraOrbit();
    model.cameraOrbit = `${correctedHeading}deg ${tiltAngle}deg auto`;
  }
}

// iOS permission for device orientation
if (typeof DeviceOrientationEvent.requestPermission === 'function') {
  document.body.addEventListener('click', async () => {
    const response = await DeviceOrientationEvent.requestPermission();
    if (response === 'granted') {
      window.addEventListener('deviceorientation', handleOrientation, true);
    } else {
      alert('Compass permission denied.');
    }
  });
} else {
  window.addEventListener('deviceorientation', handleOrientation, true);
}

// Detect user interactions
model.addEventListener('pointerdown', () => {
  userInteracting = true;
  orientationActive = false; // stop device-orientation while interacting
});

model.addEventListener('pointerup', () => {
  userInteracting = false;
  // smooth realign after a small delay
  setTimeout(() => { orientationActive = true; }, 500);
});

// Optional: Recenter button
recenterBtn.addEventListener('click', () => {
  model.cameraOrbit = `0deg ${tiltAngle}deg auto`;
});
</script>
</body>
</html>
